<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="no-referrer" name="referrer">
    <link href="data:image/x-icon;," rel="icon">
    <title>github.com/dbghelp - Shaka UI Enhanced IPTV Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css" rel="stylesheet">
    <link href="https://dbghelp.github.io/xml-epg.css" rel="stylesheet">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background-color: #282c34; }
        #playlist { width: 350px; background-color: #282c34; color: #fff; overflow-y: auto; border-right: 1px solid #444; padding: 20px; box-shadow: 2px 0 5px rgb(0 0 0 / .2); display: flex; flex-direction: column; }
        #search-input, #url-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #444; border-radius: 5px; background-color: #3c4043; color: #fff; font-size: 1em; box-sizing: border-box; }
        #epg-button { display: none; width: 100%; padding: 10px; margin-bottom: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #fetch-button { width: 100%; padding: 10px; margin-bottom: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #fetch-button:hover, #epg-button:hover { background-color: #4fa3c4; }
        #video-container { flex: 1; display: flex; flex-direction: column; z-index: 2; position: relative; background-color: #000; }
        #shaka-container { width: 100%; height: 100%; }
        #video { width: 100%; height: 100%; background-color: #000; }
        #loading-indicator { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; z-index: 10; text-align: center; }
        #video-list { list-style: none; padding: 0; margin: 0; }
        #video-list li { padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; transition: background-color .3s ease, transform .2s ease; display: flex; align-items: center; }
        #video-list li:hover { background-color: #61dafb; transform: scale(1.05); }
        #video-list img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; object-fit: contain; loading: lazy; }
        .video-title { font-size: 1em; }
        .active { background-color: #4fa3c4; }
        #overlay { display: none; flex-direction: column; align-items: center; overflow-y: auto; z-index: 2; flex: 1; }
        #epg-container { display: none; z-index: 1000; position: fixed; width: 100%; height: 100%; overflow-y: scroll; overflow-x: scroll; background-color: #282c34; }
        #search-input { display: none; }
        .input-container { position: relative; display: flex; align-items: center; width: 100%; }
        #upload-button { width: 10%; padding: 10px; margin-bottom: 10px; margin-left: 5px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #upload-button:hover { background-color: #4fa3c4; }
        .debounce-input { transition: all 0.1s ease; }

        /* Shaka UI Custom Styles from Example */
        div a img { visibility: hidden; }
        .shaka-seek-bar-container .shaka-seek-bar,
        .shaka-volume-bar-container .shaka-volume-bar {
            background: linear-gradient(to right, #051937, #00205b, #00247e, #22229f, #510dbc);
        }
        .shaka-video-container .material-icons-round { color: #00abe2; }
        .shaka-spinner-path {
            stroke-dasharray: 1, 2000;
            stroke-dashoffset: 0;
            animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;
            stroke-linecap: round;
        }
        @keyframes color {
            0%, 100% { stroke: #d62d20; }
            40% { stroke: #0057e7; }
            66% { stroke: #008744; }
            80%, 90% { stroke: #ffa700; }
        }
        @keyframes dash {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body>
    <div id="playlist">
        <div class="input-container">
            <input id="url-input" placeholder="Enter M3U8 Playlist URL">
            <input id="file-input" style="display: none" type="file">
            <button id="upload-button" onclick="document.getElementById('file-input').click()">↑</button>
        </div>
        <button id="fetch-button">Load Playlist</button>
        <button id="epg-button" onclick="openEPG()">EPG</button>
        <input id="search-input" placeholder="Search..." class="debounce-input">
        <ul id="video-list"></ul>
    </div>
    <div id="video-container">
        <div id="shaka-container" data-shaka-player-container>
            <video autoplay muted data-shaka-player id="video" style="width:100%; height:100%;"></video>
        </div>
        <div id="loading-indicator">
            <div>Loading stream... (Shaka UI Enhanced)</div>
            <div id="error-msg" style="color: #ff6b6b; font-size: 0.9em;"></div>
        </div>
    </div>
    <div id="overlay"></div>
    <div id="epg-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <script src="https://dbghelp.github.io/M3U8Interpreter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://dbghelp.github.io/xml-epg.js"></script>
    <script>
        var xmlepg = new XMLEPG();
        var overlay = document.getElementById('overlay');
        var videoContainer = document.getElementById('video-container');
        var epgContainer = document.getElementById('epg-container');
        var loadingIndicator = document.getElementById('loading-indicator');
        var errorMsg = document.getElementById('error-msg');
        var hideOverlayTimeout = null;
        var player;
        var ui;
        var channels;
        var lastActiveChannel;

        // Optimized overlay events (asli)
        overlay.addEventListener('mouseenter', () => {
            if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
            overlay.style.display = 'flex';
            videoContainer.style.display = 'none';
        });
        overlay.addEventListener('mouseleave', () => {
            hideOverlayTimeout = setTimeout(() => {
                overlay.style.display = 'none';
                videoContainer.style.display = 'flex';
            }, 100);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const videoElement = document.getElementById('video');
            const videoList = document.getElementById('video-list');
            const searchInput = document.getElementById('search-input');
            const urlInput = document.getElementById('url-input');
            const fetchButton = document.getElementById('fetch-button');
            const fileInput = document.getElementById('file-input');
            let selectedFileContent = null;

            // Shaka UI Init (from example)
            async function initShaka() {
                const video = document.getElementById('video');
                ui = video['ui'];
                const controls = ui.getControls();
                player = controls.getPlayer();
                window.player = player; // For console tweaks
                window.ui = ui;

                // Config like example: ABR restrictions for quality control
                player.configure({
                    drm: {
                        clearKeys: {} // Placeholder, will be set per channel
                    },
                    abr: {
                        defaultBandwidthEstimate: 16888, // Low estimate for quick start
                        enabled: true,
                        restrictions: {
                            minHeight: 359, // Min quality 360p
                            maxHeight: 720  // Max 720p (tweak via console if needed)
                        }
                    },
                    streaming: {
                        bufferBehind: 15,
                        rebufferingGoal: 5,
                        lowLatencyMode: true,
                        bufferingGoal: 20,
                        retryParameters: {
                            maxAttempts: 3,
                            baseDelay: 1000,
                            backoffFactor: 2,
                            fuzzFactor: 0.5
                        }
                    }
                });

                player.addEventListener('error', onPlayerErrorEvent);
                controls.addEventListener('error', onUIErrorEvent);

                shaka.polyfill.installAll();
                console.log('Shaka UI initialized!');
            }

            function onPlayerErrorEvent(event) {
                onPlayerError(event.detail);
            }
            function onPlayerError(error) {
                console.error('Error code', error.code, 'object', error);
                errorMsg.textContent = 'Stream error: ' + error.message + '. Retrying...';
                if (error.severity === shaka.util.Error.Severity.RECOVERABLE) {
                    setTimeout(() => player.retryStreaming(), 2000);
                }
                loadingIndicator.style.display = 'none';
            }
            function onUIErrorEvent(event) {
                onPlayerError(event.detail);
            }
            function initFailed() {
                console.error('Unable to load Shaka UI!');
                showToast('Shaka UI load failed – fallback to basic player');
            }

            // Load Shaka UI
            document.addEventListener('shaka-ui-loaded', initShaka);
            document.addEventListener('shaka-ui-load-failed', initFailed);

            // Event listeners for loading indicator
            player?.addEventListener('loading', () => {
                loadingIndicator.style.display = 'block';
                errorMsg.textContent = '';
            });
            player?.addEventListener('loaded', () => loadingIndicator.style.display = 'none');

            var extracted = extractAppendedURL();
            if (extracted) {
                document.getElementById('upload-button').remove();
                document.getElementById('url-input').remove();
                document.getElementById('fetch-button').remove();
                setPlaylistFromUrl(extracted);
            }

            fetchButton.addEventListener('click', async () => {
                const url = urlInput.value;
                if (selectedFileContent) {
                    setPlaylistFromFile(selectedFileContent);
                } else if (url) {
                    setPlaylistFromUrl(url);
                }
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    urlInput.value = file.name;
                    const reader = new FileReader();
                    reader.onload = (e) => { selectedFileContent = e.target.result; };
                    reader.readAsText(file);
                }
            });

            // Debounced search (tetap)
            let searchTimeout;
            searchInput.addEventListener('input', (event) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = event.target.value;
                    filterPlaylist(searchTerm);
                }, 300);
            });

            async function setPlaylistFromUrl(url) {
                try {
                    console.log('Fetching playlist from:', url);
                    const response = await fetch(url);
                    if (response.ok) {
                        const text = await response.text();
                        parseAndSetPlaylist(text);
                    } else {
                        console.error('Failed to fetch M3U8 playlist.');
                        showToast('Gagal fetch playlist: ' + response.status);
                    }
                } catch (error) {
                    console.error('Error fetching M3U8 playlist:', error);
                    showToast('Error: ' + error.message);
                }
            }

            async function setPlaylistFromFile(content) {
                parseAndSetPlaylist(content);
            }

            async function parseAndSetPlaylist(content) {
                try {
                    console.log('Parsing playlist...');
                    const m3u8Interpreter = new M3U8Interpreter(content);
                    m3u8Interpreter.parse();
                    channels = m3u8Interpreter.getChannels();
                    const urls = m3u8Interpreter.getUrlTvg();
                    xmlepg.setPlaylistChannels(channels);

                    if (urls && urls.length > 0) {
                        console.log('Loading EPG from:', urls);
                        await xmlepg.load(urls).then(() => {
                            xmlepg.displayAllPrograms('epg-container', 'xmlepg');
                        }).catch(err => {
                            console.warn('EPG load failed, but playlist ok:', err);
                        });
                        document.getElementById('epg-button').style.display = 'block';
                    }

                    updatePlaylist(channels);
                    document.getElementById('search-input').style.display = 'block';
                    console.log('Playlist loaded: ' + channels.length + ' channels');
                    showToast('Playlist loaded: ' + channels.length + ' channels');
                } catch (error) {
                    console.error('Parse error:', error);
                    showToast('Gagal parse playlist: ' + error.message);
                }
            }

            window.loadVideo = async function(manifestUrl, licenseKey) {
                if (!player) {
                    console.warn('Player not ready, retrying...');
                    setTimeout(() => loadVideo(manifestUrl, licenseKey), 500);
                    return;
                }
                console.log('Loading video:', manifestUrl);
                if (licenseKey != null && !Array.isArray(licenseKey)) {
                    licenseKey = JSON.parse(decodeURIComponent(licenseKey));
                }
                if (licenseKey) {
                    licenseKey.forEach(pair => {
                        player.configure({ drm: { clearKeys: { [pair.keyId]: pair.key } } });
                    });
                }

                loadingIndicator.style.display = 'block';
                try {
                    await player.load(manifestUrl);
                    console.log('The video has now been loaded!');
                    await videoElement.play().catch(e => console.warn('Autoplay blocked:', e));
                } catch (error) {
                    console.error('Shaka load failed:', error);
                    errorMsg.textContent = 'Fallback to native...';
                    videoElement.src = manifestUrl;
                    await videoElement.play().catch(e => console.warn('Native play failed:', e));
                }
            };

            function updatePlaylist(channelsList) {
                console.log('Updating playlist UI...');
                videoList.innerHTML = '';
                channelsList.forEach(channel => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <img src="${channel.tvgLogo}" alt="${channel.channelName} logo" loading="lazy">
                        <span class="video-title">${channel.channelName}</span>
                    `;
                    const imgElement = listItem.querySelector('img');

                    imgElement.onmouseenter = () => {
                        try {
                            xmlepg.displayPrograms('overlay', channel.tvgId);
                            overlay.style.display = 'flex';
                            videoContainer.style.display = 'none';
                            if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
                        } catch (e) {
                            console.warn('EPG hover failed:', e);
                        }
                    };
                    imgElement.onmouseleave = () => {
                        hideOverlayTimeout = setTimeout(() => {
                            overlay.style.display = 'none';
                            videoContainer.style.display = 'flex';
                        }, 100);
                    };

                    listItem.onclick = () => {
                        loadVideo(channel.manifestUrl, channel.licenseKey);
                        Array.from(videoList.children).forEach(li => li.classList.remove('active'));
                        listItem.classList.add('active');
                        lastActiveChannel = listItem.innerHTML;
                    };

                    videoList.appendChild(listItem);
                });
            }

            function filterPlaylist(searchTerm) {
                const filteredChannels = channels.filter(channel => channel.channelName.toLowerCase().includes(searchTerm.toLowerCase()));
                updatePlaylist(filteredChannels);
            }
        });

        function extractAppendedURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('file');
        }

        function openEPG() {
            epgContainer.style.display = 'block';
            xmlepg.timelineNeedleRender();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 9999; opacity: 0; transition: opacity 0.5s;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 10);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        function copyToClipboard(text, name) {
            text = decodeURIComponent(text);
            navigator.clipboard.writeText(text.replace(/x123x/g, "'")).then(() => {
                showToast(name + ' command successfully copied to clipboard');
            }).catch(err => {
                showToast('Failed to copy ' + name + ' download command: ' + err);
            });
        }
    </script>
</body>
</html>
