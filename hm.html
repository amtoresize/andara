<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="no-referrer" name="referrer">
    <link href="data:image/x-icon;," rel="icon">
    <title>github.com/dbghelp - Optimized IPTV Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.min.css" rel="stylesheet">
    <link href="https://dbghelp.github.io/xml-epg.css" rel="stylesheet">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background-color: #282c34; }
        #playlist { width: 350px; background-color: #282c34; color: #fff; overflow-y: auto; border-right: 1px solid #444; padding: 20px; box-shadow: 2px 0 5px rgb(0 0 0 / .2); display: flex; flex-direction: column; }
        #search-input, #url-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #444; border-radius: 5px; background-color: #3c4043; color: #fff; font-size: 1em; box-sizing: border-box; }
        #epg-button { display: none; width: 100%; padding: 10px; margin-bottom: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #fetch-button { width: 100%; padding: 10px; margin-bottom: 10px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #fetch-button:hover, #epg-button:hover { background-color: #4fa3c4; }
        #video-container { flex: 1; display: flex; flex-direction: column; z-index: 2; }
        #video { flex: 1; width: 100%; height: 100%; background-color: #000; }
        #loading-indicator { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; z-index: 10; }
        #video-list { list-style: none; padding: 0; margin: 0; }
        #video-list li { padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; transition: background-color .3s ease, transform .2s ease; display: flex; align-items: center; }
        #video-list li:hover { background-color: #61dafb; transform: scale(1.05); }
        #video-list img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; object-fit: contain; loading: lazy; }
        .video-title { font-size: 1em; }
        .active { background-color: #4fa3c4; }
        #overlay { display: none; flex-direction: column; align-items: center; overflow-y: auto; z-index: 2; flex: 1; }
        #epg-container { display: none; z-index: 1000; position: fixed; width: 100%; height: 100%; overflow-y: scroll; overflow-x: scroll; background-color: #282c34; }
        #search-input { display: none; }
        .input-container { position: relative; display: flex; align-items: center; width: 100%; }
        #upload-button { width: 10%; padding: 10px; margin-bottom: 10px; margin-left: 5px; background-color: #61dafb; color: #000; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 8px rgb(0 0 0 / .3); }
        #upload-button:hover { background-color: #4fa3c4; }
        .debounce-input { transition: all 0.1s ease; }
    </style>
</head>
<body>
    <div id="playlist">
        <div class="input-container">
            <input id="url-input" placeholder="Enter M3U8 Playlist URL">
            <input id="file-input" style="display: none" type="file">
            <button id="upload-button" onclick="document.getElementById('file-input').click()">â†‘</button>
        </div>
        <button id="fetch-button">Load Playlist</button>
        <button id="epg-button" onclick="openEPG()">EPG</button>
        <input id="search-input" placeholder="Search..." class="debounce-input">
        <ul id="video-list"></ul>
    </div>
    <div id="video-container">
        <video autoplay muted controls id="video"></video>
        <div id="loading-indicator">Loading stream... (Optimized for low latency)</div>
    </div>
    <div id="overlay"></div>
    <div id="epg-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.compiled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> <!-- Fallback for HLS -->
    <script src="https://dbghelp.github.io/M3U8Interpreter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://dbghelp.github.io/xml-epg.js"></script>
    <script>
        var xmlepg = new XMLEPG();
        var overlay = document.getElementById('overlay');
        var videoContainer = document.getElementById('video-container');
        var epgContainer = document.getElementById('epg-container');
        var loadingIndicator = document.getElementById('loading-indicator');
        var hideOverlayTimeout = null;
        var channelsCache = []; // Cache for EPG programs
        var player;
        var hlsPlayer; // Fallback HLS.js instance
        var lastActiveChannel;

        // Optimized overlay events
        overlay.addEventListener('mouseenter', () => {
            if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
            overlay.style.display = 'flex';
            videoContainer.style.display = 'none';
        });
        overlay.addEventListener('mouseleave', () => {
            hideOverlayTimeout = setTimeout(() => {
                overlay.style.display = 'none';
                videoContainer.style.display = 'flex';
            }, 100);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const videoElement = document.getElementById('video');
            const videoList = document.getElementById('video-list');
            const searchInput = document.getElementById('search-input');
            const urlInput = document.getElementById('url-input');
            const fetchButton = document.getElementById('fetch-button');
            const fileInput = document.getElementById('file-input');
            const uploadButton = document.getElementById('upload-button');
            let selectedFileContent = null;
            let channels = [];

            // Init Shaka Player with optimizations
            player = new shaka.Player(videoElement);
            shaka.polyfill.installAll();
            player.configure({
                streaming: {
                    bufferBehind: 15, // Lower buffer for faster start
                    rebufferingGoal: 5, // Aggressive rebuffering
                    lowLatencyMode: true, // Enable low-latency for HLS
                    bufferingGoal: 20,
                    retryParameters: {
                        maxAttempts: 3,
                        baseDelay: 1000,
                        backoffFactor: 2,
                        fuzzFactor: 0.5
                    }
                },
                abr: {
                    enabled: true,
                    defaultBandwidthEstimate: 1000000, // Start with lower estimate for quick init
                    switchInterval: 2 // Faster quality switches
                },
                drm: { clearKeys: {} } // Placeholder
            });
            player.addEventListener('error', onPlayerError);
            player.addEventListener('loading', () => loadingIndicator.style.display = 'block');
            player.addEventListener('loaded', () => loadingIndicator.style.display = 'none');

            // Fallback HLS.js init
            if (Hls.isSupported()) {
                hlsPlayer = new Hls({
                    lowLatencyMode: true,
                    backBufferLength: 10,
                    maxBufferLength: 20,
                    maxMaxBufferLength: 30,
                    startLevel: -1 // Auto start lowest quality
                });
                hlsPlayer.on(Hls.Events.ERROR, onHlsError);
            }

            var extracted = extractAppendedURL();
            if (extracted) {
                document.getElementById('upload-button').remove();
                document.getElementById('url-input').remove();
                document.getElementById('fetch-button').remove();
                setPlaylistFromUrl(extracted);
            }

            fetchButton.addEventListener('click', async () => {
                const url = urlInput.value;
                if (selectedFileContent) {
                    setPlaylistFromFile(selectedFileContent);
                } else if (url) {
                    setPlaylistFromUrl(url);
                }
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    urlInput.value = file.name;
                    const reader = new FileReader();
                    reader.onload = (e) => { selectedFileContent = e.target.result; };
                    reader.readAsText(file);
                }
            });

            // Debounced search
            let searchTimeout;
            searchInput.addEventListener('input', (event) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = event.target.value;
                    filterPlaylist(searchTerm);
                }, 300); // Debounce 300ms
            });

            async function setPlaylistFromUrl(url) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const text = await response.text();
                        parseAndSetPlaylist(text);
                    } else {
                        console.error('Failed to fetch M3U8 playlist.');
                    }
                } catch (error) {
                    console.error('Error fetching M3U8 playlist:', error);
                }
            }

            async function setPlaylistFromFile(content) {
                parseAndSetPlaylist(content);
            }

            async function parseAndSetPlaylist(content) {
                const m3u8Interpreter = new M3U8Interpreter(content);
                m3u8Interpreter.parse();
                channels = m3u8Interpreter.getChannels();
                const urls = m3u8Interpreter.getUrlTvg();
                xmlepg.setPlaylistChannels(channels);
                // Cache EPG for faster access
                await xmlepg.load(urls).then(() => {
                    channels.forEach(ch => channelsCache[ch.tvgId] = xmlepg.getProgramsByChannel(ch.tvgId));
                    xmlepg.displayAllPrograms('epg-container', 'xmlepg');
                });
                if (urls != null && urls.length !== 0) {
                    document.getElementById('epg-button').style.display = 'block';
                }
                updatePlaylist(channels);
                document.getElementById('search-input').style.display = 'block';
            }

            window.loadVideo = async function(manifestUrl, licenseKey) {
                if (licenseKey != null && !Array.isArray(licenseKey)) {
                    licenseKey = JSON.parse(decodeURIComponent(licenseKey));
                }
                if (licenseKey) {
                    licenseKey.forEach(pair => {
                        player.configure({ drm: { clearKeys: { [pair.keyId]: pair.key } } });
                    });
                }

                loadingIndicator.style.display = 'block';
                // Prefetch manifest metadata
                try {
                    await fetch(manifestUrl, { method: 'HEAD' });
                } catch (e) { /* Ignore prefetch errors */ }

                // Try Shaka first
                try {
                    await player.load(manifestUrl);
                    videoElement.play().catch(() => {}); // Ignore play promise for now
                    return;
                } catch (e) {
                    console.warn('Shaka failed, falling back to HLS.js');
                    fallbackToHls(manifestUrl);
                }
            };

            function fallbackToHls(url) {
                if (hlsPlayer) {
                    hlsPlayer.loadSource(url);
                    hlsPlayer.attachMedia(videoElement);
                    hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoElement.play().catch(() => {});
                        loadingIndicator.style.display = 'none';
                    });
                } else {
                    videoElement.src = url;
                    videoElement.play().catch(() => {});
                    loadingIndicator.style.display = 'none';
                }
            }

            function onPlayerError(event) {
                console.error('Shaka error:', event.detail);
                if (event.detail.code === shaka.util.Error.Severity.RECOVERABLE) {
                    // Auto retry
                    setTimeout(() => player.retryStreaming(), 2000);
                }
                loadingIndicator.style.display = 'none';
            }

            function onHlsError(event, data) {
                console.error('HLS error:', data);
                loadingIndicator.style.display = 'none';
            }

            function updatePlaylist(channelsList) {
                videoList.innerHTML = '';
                channelsList.forEach(channel => {
                    const listItem = document.createElement('li');
                    const img = document.createElement('img');
                    img.src = channel.tvgLogo || ''; // Lazy load
                    img.alt = channel.channelName + ' logo';
                    img.loading = 'lazy';
                    listItem.appendChild(img);
                    listItem.innerHTML += `<span class="video-title">${channel.channelName}</span>`;

                    // Optimized EPG hover with cache
                    img.onmouseenter = () => {
                        const programs = channelsCache[channel.tvgId] || [];
                        xmlepg.displayPrograms('overlay', channel.tvgId, programs); // Pass cached
                        overlay.style.display = 'flex';
                        videoContainer.style.display = 'none';
                        if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
                    };
                    img.onmouseleave = () => {
                        hideOverlayTimeout = setTimeout(() => {
                            overlay.style.display = 'none';
                            videoContainer.style.display = 'flex';
                        }, 100);
                    };

                    listItem.onclick = () => {
                        loadVideo(channel.manifestUrl, channel.licenseKey);
                        // Remove active class from all
                        Array.from(videoList.children).forEach(li => li.classList.remove('active'));
                        listItem.classList.add('active');
                        lastActiveChannel = channel;
                    };

                    videoList.appendChild(listItem);
                });
            }

            function filterPlaylist(searchTerm) {
                const filtered = channels.filter(ch => ch.channelName.toLowerCase().includes(searchTerm.toLowerCase()));
                updatePlaylist(filtered);
            }
        });

        function extractAppendedURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('file');
        }

        function openEPG() {
            epgContainer.style.display = 'block';
            xmlepg.timelineNeedleRender();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 9999; opacity: 0; transition: opacity 0.5s;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 10);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        function copyToClipboard(text, name) {
            text = decodeURIComponent(text);
            navigator.clipboard.writeText(text.replace(/x123x/g, "'")).then(() => {
                showToast(name + ' command successfully copied to clipboard');
            }).catch(err => {
                showToast('Failed to copy ' + name + ' download command: ' + err);
            });
        }
    </script>
</body>
</html>
